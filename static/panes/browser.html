<!DOCTYPE html>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.min.css" type="text/css" >
<link rel='stylesheet' href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<link rel="stylesheet" href="/css/canvas.css">
<link rel="stylesheet" href="/css/nav.css">

<style>
  body {}
    canvas {
        background-color: white;
    }
</style>

<body onload="startup()">

<div class = 'row nav'>
  <div class = 'col-xs-3 nav-item'>
    <a href="/crop_tool.html">üì∏</a>
  </div>
  <div class = 'col-xs-3 nav-item'>
    <a href="/volume_control.html">üîà</a>
  </div>
  <div class = 'col-xs-3 nav-item'>
    <a href="./">üòÄ</a>
  </div>
  <div class = 'col-xs-3 nav-item active'>
    <a href="./">üñç</a>
  </div>
</div>

<canvas id="canvas" width="350px" height="600px"></canvas>


<script>
  canvas = document.getElementById('canvas');
  ctx = canvas.getContext('2d');

  function startup() {
    var el = document.getElementsByTagName("canvas")[0];
    el.addEventListener("touchstart", handleStart, false);
    el.addEventListener("touchend", handleEnd, false);
    el.addEventListener("touchcancel", handleCancel, false);
    el.addEventListener("touchmove", handleMove, false);
    console.log("initialized.");
  }

var xDown = null;                                                        
var yDown = null;                                                        
var ongoingTouches = [];

function copyTouch(touch) {
  return { identifier: touch.identifier, pageX: touch.pageX, pageY: touch.pageY };
}

function handleStart(evt) {
    evt.preventDefault();
    var touches = evt.changedTouches;
    for (var i = 0; i < touches.length; i++) {
    console.log("touchstart:" + i + "...");
    ongoingTouches.push(copyTouch(touches[i]));
    console.log("touchstart:" + i + ".");
  }                                         
    xDown = evt.touches[0].clientX;                                      
    yDown = evt.touches[0].clientY;                                      
};                                                

function handleMove(evt) {
    evt.preventDefault();
  var touches = evt.changedTouches;

  for (var i = 0; i < touches.length; i++) {
    var idx = ongoingTouchIndexById(touches[i].identifier);

    if (idx >= 0) {
      ongoingTouches.splice(idx, 1, copyTouch(touches[i]));  // swap in the new touch record
    } 
  }
    if ( ! xDown || ! yDown ) {
        return;
    }

    var xUp = evt.touches[0].clientX;                                    
    var yUp = evt.touches[0].clientY;

    var xDiff = xDown - xUp;
    var yDiff = yDown - yUp;

    if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
        if ( xDiff > 0 ) {
            /* left swipe */
            console.log('left swipe');
            send_event({
                action: 'key_press',
                string: 'tab',
                then: ['control', 'shift']
            }) 
        } else {
            send_event({
                action: 'key_press',
                string: 'tab',
                then: 'control'
            })
        }                       
    } else {
        if ( yDiff > 0 && yDiff < 20) {
            /* up swipe */ 
            send_event({
                action: 'mouse_move',
                string: '4',
                then: 'up'
            })
        }
        else if (yDiff >= 20) {
              send_event({
                action: 'key_press',
                string: 't',
                then: ['control', 'shift']
              })
        }
         else if (yDiff < 0 && yDiff > -20){ 
            /* down swipe */
            send_event({
                action: 'mouse_move',
                string: '4',
                then: 'down'
            })
            }
            else {
              send_event({
                action: 'key_press',
                string: 'w',
                then: 'control'
              })
            }
    }
    /* reset values */
    xDown = null;
    yDown = null;                                             
};

function handleEnd(evt) {
  evt.preventDefault();
  var touches = evt.changedTouches;

  for (var i = 0; i < touches.length; i++) {
    var idx = ongoingTouchIndexById(touches[i].identifier);

    if (idx >= 0) {
      ongoingTouches.splice(idx, 1);  // remove it; we're done
    }
  }
}
function handleCancel(){

}

function ongoingTouchIndexById(idToFind) {
  for (var i = 0; i < ongoingTouches.length; i++) {
    var id = ongoingTouches[i].identifier;
    
    if (id == idToFind) {
      return i;
    }
  }
  return -1;    // not found
}

</script>
<script src="/socket.io/socket.io.js"></script>
<script src="/phone.js"></script>